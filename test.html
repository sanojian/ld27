<html>
	<head>
	
		<script type="text/javascript" src="./includes/box2dweb/Box2dWeb-2.1.a.3.js"></script>
		<script type="text/javascript" src="./includes/raphael2.js"></script>

		<script>

var g_game = {
	frame: 0,
	worldScale: 30,
	rocket_vY: 0,
	bodies: [],
	overlays: []
};
		
var g_shapes = [
	{ name: 'box', vert: [[[0,0],[2,0],[2,2],[0,2]]] },
	{ name: 'triangle', vert: [[[1,0],[2,1],[0,2]]] },
	{ name: 'L', vert: [[[0,0],[1,0],[1,1],[0,1]],[[0,1],[2,1],[2,2],[0,2]]] },
];

function init() {
	var b2Vec2 = Box2D.Common.Math.b2Vec2;
	var b2AABB = Box2D.Collision.b2AABB;
	var b2BodyDef = Box2D.Dynamics.b2BodyDef;
	var b2Body = Box2D.Dynamics.b2Body;
	var b2FixtureDef = Box2D.Dynamics.b2FixtureDef;
	var b2Fixture = Box2D.Dynamics.b2Fixture;
	var b2World = Box2D.Dynamics.b2World;
	var b2PolygonShape = Box2D.Collision.Shapes.b2PolygonShape;
	var b2DebugDraw = Box2D.Dynamics.b2DebugDraw;
     
	var worldScale = g_game.worldScale;
	
	var world = new b2World(new b2Vec2(0, 10),true);
	g_game.world = world;
	
	var canvasPosition = getElementPosition(document.getElementById("canvas"));
	
	debugDraw();             
	//window.setInterval(update,1000/60);
	
	createBox(640,30,320,480,b2Body.b2_staticBody);
	//createBox(640,30,320,0,b2Body.b2_staticBody);
	createBox(30,480,0,240,b2Body.b2_staticBody);
	createBox(30,480,640,240,b2Body.b2_staticBody);
	
	g_game.rocket = createBox(120, 30, 200, 400, b2Body.b2_kinematicBody);
	
	var holder = document.getElementById('raphHolder');
	holder.style.left = '0px';
	holder.style.top = '0px';
	g_game.raphPaper = Raphael("raphHolder");
	g_game.raphPaper.rect(0, 0, g_game.raphPaper.width, g_game.raphPaper.height).attr({ stroke: '#fff', 'stroke-width': 4 });
	//g_game.raphPaper.setViewBox(0, 0, g_game.raphPaper.width/worldScale, g_game.raphPaper.height/worldScale);
	g_game.timer = g_game.raphPaper.text(500, 100, '10').attr({ stroke: '#fff', fill: '#fff', 'font-size': '48pt' });
	
	document.addEventListener("mousedown",function(e){
		var cx = e.clientX-canvasPosition.x;
		var cy = e.clientY-canvasPosition.y;
		var size = 30;
		var shape = g_shapes[Math.floor(Math.random() * g_shapes.length)];
		//var body = createBox(w, h, cx, cy, b2Body.b2_dynamicBody);
		var body = createPolygon(cx, cy, shape, 30);
		g_game.bodies.push(body);
		
		var path = '';
		for (var p=0;p<shape.vert.length;p++) {
			for (var i=0;i<shape.vert[p].length;i++) {
				path += (i == 0 ? 'M' : 'L') + (shape.vert[p][i][0] * size/2) + ' ' + (shape.vert[p][i][1] * size/2);
			}
		}
		
		var overlay = g_game.raphPaper.path(path).attr({ fill: '#999', opacity: 0.3 });
		overlay.game_size = size;
		g_game.overlays.push(overlay);
	});
	
	function createBox(width,height,pX,pY,type){
		var bodyDef = new b2BodyDef;
		bodyDef.type = type;
		bodyDef.position.Set(pX/worldScale,pY/worldScale);
		var polygonShape = new b2PolygonShape;
		polygonShape.SetAsBox(width/2/worldScale,height/2/worldScale);
		var fixtureDef = new b2FixtureDef;
		fixtureDef.density = 1.0;
		fixtureDef.friction = 0.5;
		fixtureDef.restitution = 0.5;
		fixtureDef.shape = polygonShape;
		var body=world.CreateBody(bodyDef);
		body.CreateFixture(fixtureDef);
		return body;
	}
	
	function createPolygon(cx, cy, shape, size) {
		var bodyDef = new b2BodyDef();
		bodyDef.type = b2Body.b2_dynamicBody;
		bodyDef.position.Set(cx/worldScale, cy/worldScale);
		var body = world.CreateBody(bodyDef);
		
		for (var p=0;p<shape.vert.length;p++) {
			var vecs = [];
			for(var i=0;i<shape.vert[p].length;i++) {
				var cc = new b2Vec2();
				cc.Set((size/2) * shape.vert[p][i][0]/worldScale, (size/2) * shape.vert[p][i][1]/worldScale);
				vecs[i] = cc;
			}
			var fixtureDef = new b2FixtureDef;
			fixtureDef.density = 1.0;
			fixtureDef.friction = 0.5;
			fixtureDef.restitution = 0.5;
			fixtureDef.shape = new b2PolygonShape;
			fixtureDef.shape.SetAsArray(vecs,vecs.length);
			body.CreateFixture(fixtureDef);
			
		}
		
		return body;
	}
	
	function debugDraw(){
		var debugDraw = new b2DebugDraw();
		debugDraw.SetSprite(document.getElementById("canvas").getContext("2d"));
		debugDraw.SetDrawScale(30.0);
		debugDraw.SetFillAlpha(0.5);
		debugDraw.SetLineThickness(1.0);
		debugDraw.SetFlags(b2DebugDraw.e_shapeBit | b2DebugDraw.e_jointBit);
		world.SetDebugDraw(debugDraw);
	}
		
	//http://js-tut.aardon.de/js-tut/tutorial/position.html
	function getElementPosition(element) {
		var elem=element, tagname="", x=0, y=0;
		while((typeof(elem) == "object") && (typeof(elem.tagName) != "undefined")) {
			y += elem.offsetTop;
			x += elem.offsetLeft;
			tagname = elem.tagName.toUpperCase();
			if(tagname == "BODY"){
				elem=0;
			}
			if(typeof(elem) == "object"){
				if(typeof(elem.offsetParent) == "object"){
					elem = elem.offsetParent;
				}
			}
		}
		return {x: x, y: y};
	}

	// start the game
	(function animloop(){
		requestAnimFrame(animloop);
		doGameLoop();
	})();

}

// shim layer with setTimeout fallback
window.requestAnimFrame = (function(){
  return  window.requestAnimationFrame       ||
          window.webkitRequestAnimationFrame ||
          window.mozRequestAnimationFrame    ||
          function( callback ){
            window.setTimeout(callback, 1000 / 60);
          };
})();
	
function doGameLoop() {

	if (g_game.bLaunched) {
		g_game.rocket_vY -= 0.008;
		g_game.rocket.SetLinearVelocity(new Box2D.Common.Math.b2Vec2(0, g_game.rocket_vY));	
	}
	else if (g_game.frame % 60 == 0) {
		var timeLeft = 5 - Math.floor(g_game.frame/60);
		g_game.timer.attr({ text: timeLeft });
		if (timeLeft <= 0) {
			g_game.bLaunched = true;
		}
	}
			
	g_game.world.Step(1/60,10,10);
	g_game.world.DrawDebugData();
	g_game.world.ClearForces();

	for (var i=0;i<g_game.bodies.length;i++) {
		var angle = Math.atan2(g_game.bodies[i].m_xf.R.col1.y, g_game.bodies[i].m_xf.R.col1.x);
		g_game.overlays[i].transform('t' + g_game.bodies[i].m_xf.position.x*g_game.worldScale 
									+ ',' + g_game.bodies[i].m_xf.position.y*g_game.worldScale
									+ 'r' + (angle * 180 / Math.PI) + ',0,0');
	}
	
	g_game.frame++;
	
}
		</script>
		<style>
		
			body {
				margin: 0;
			}
		
		</style>
		
	</head>
	<body onload="init()">
		<canvas id="canvas" width="640" height="480" style="background-color:#333333;" ></canvas>
		<div id="raphHolder" style="position: absolute; width: 640px; height: 480px;" />
	</body>
</html>